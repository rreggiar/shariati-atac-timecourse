---
title: "atac timecourse analysis"
date: "`r Sys.Date()`"
author: 'Roman E. Reggiardo'
output: html_document
editor_options: 
  chunk_output_type: console
---
# nb_setup
```{r, setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 8, collapse = T)
knitr::opts_chunk$set(message = F)
# here::set_here('/home/rreggiar/')
here::here()
suppressPackageStartupMessages(library(tidyverse))
```

```{r}
# these are hard-coded since the data files are all the same
peak_colnames <- c('peak_id', 'chr', 'start', 'end',
                   'strand', 'score', 'focus', 'anno',
                   'detail', 'distance_tss', 'nearest_prom',
                   'entrez_id', 'nearest_unigene', 'nearest_refseq',
                   'nearest_ensg', 'gene_name', 'gene_alias', 
                   'gene_desc', 'biotype')
# grab all the output directories
data_dirs <- list.dirs(here::here('data'), recursive = F)
# aggregate the output data w/in dirs to a list of DFs
data_agg <- 
  lapply(data_dirs, function(dir) { 
  
    dir_name <- basename(dir)
    
    lfc4_colnames <- c('peak_id', 'chr', 'start', 'end',
                     'strand', 'score', 'focus', 
                     'tot_tags', 'bg_tags', 'foldChange', 'pval')
    
    peak <- 
      vroom::vroom(
        list.files(dir, 
                   pattern = '.peak',
                   full.names = T), col_names = peak_colnames
      )
    
    lfc4 <- 
    vroom::vroom(
      list.files(dir, 
                 pattern = 'LFC4',
                 full.names = T), col_names = lfc4_colnames
      )
    
    # add identifying column and calculate log2FC
    lfc4$foldChange <- as.numeric(lfc4$foldChange)
    lfc4$comparison <- dir_name
    lfc4$log2FoldChange <- log2(lfc4$foldChange)
    

    peak_lfc4 <- merge(peak, lfc4, by = c('peak_id', 'chr', 
                                            'start', 'end', 
                                            'strand'))
    return(peak_lfc4)

   }
)
# remove NULL entries (AvA comparisons)
data_agg_filt <- data_agg[!sapply(data_agg, is.null)]
# bind results into single data frame
atac_data <- do.call('rbind', data_agg_filt)

atac_tidy <- 
  atac_data %>% 
    mutate(enriched_in = str_split_fixed(comparison, pattern = '.vs.', n = 3)[,1],
           compared_to = str_split_fixed(comparison, pattern = '.vs.', n = 3)[,2]) %>% 
    mutate(enriched_time = gsub(str_split_fixed(enriched_in, pattern = '_', n = 2)[,2], 
                                pattern = 'hr', replacement = ''),
           compared_time = gsub(str_split_fixed(compared_to, pattern = '_', n = 2)[,2], 
                                pattern = 'hr', replacement = '')) %>% 
    mutate(enriched_context = str_split_fixed(enriched_in, pattern = '_', n = 2)[,1],
           compared_context = str_split_fixed(compared_to, pattern = '_', n = 2)[,1])
```

```{r}

```


